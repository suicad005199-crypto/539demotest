<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 大數據與尾數分析器</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .section { margin-bottom: 30px; padding: 20px; border-radius: 10px; background: #fff; border: 1px solid #eee; }
        h2 { color: #d32f2f; border-bottom: 2px solid #d32f2f; padding-bottom: 10px; }
        .ball-container { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .ball { width: 45px; height: 45px; line-height: 45px; border-radius: 50%; background: #d32f2f; color: white; font-weight: bold; text-align: center; }
        .tail-ball { background: #2980b9; }
        button { width: 100%; padding: 15px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }
        .highlight { color: #e67e22; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>539 數據分析系統</h2>
    
    <div class="section">
        <strong>1. 數據上傳</strong>
        <input type="file" id="csvFile" accept=".csv" style="margin-top:10px;">
    </div>

    <div class="section">
        <strong>2. 歷史最強熱門組 (Top 5)</strong>
        <div class="ball-container" id="hotResult"></div>
    </div>

    <div class="section">
        <strong>3. 尾數遺漏分析 (最久沒開出的尾數)</strong>
        <div id="tailAnalysis">等待數據分析...</div>
        <div class="ball-container" id="tailRecommend"></div>
    </div>

    <button id="predictBtn" disabled onclick="runAnalysis()">執行全面數據預測</button>
</div>

<script>
    let rawData = []; // 儲存所有期數數據

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const lines = event.target.result.trim().split('\n');
            rawData = lines.slice(1).map(line => line.split(',')); // 排除標題列
            document.getElementById('predictBtn').disabled = false;
            alert("數據讀取完成！");
        };
        reader.readAsText(file);
    });

    function runAnalysis() {
        if (rawData.length === 0) return;

        // --- 1. 熱門號碼統計 ---
        let counts = {};
        rawData.forEach(row => {
            for (let i = 1; i <= 5; i++) {
                let num = parseInt(row[i]);
                if (!isNaN(num)) counts[num] = (counts[num] || 0) + 1;
            }
        });

        let sortedHot = Object.keys(counts).map(k => ({n: k, c: counts[k]}))
                        .sort((a,b) => b.c - a.c).slice(0, 5);
        displayBalls('hotResult', sortedHot.map(x => x.n).sort((a,b)=>a-b), 'ball');

        // --- 2. 尾數遺漏分析 (幾尾最久沒開) ---
        // 紀錄 0-9 尾最後一次出現的 index (0 為最新一期)
        let lastSeenTail = Array(10).fill(-1); 
        
        for (let i = 0; i < rawData.length; i++) {
            for (let j = 1; j <= 5; j++) {
                let num = parseInt(rawData[i][j]);
                if (!isNaN(num)) {
                    let tail = num % 10;
                    if (lastSeenTail[tail] === -1) {
                        lastSeenTail[tail] = i; // 紀錄是第幾期前出現的
                    }
                }
            }
        }

        // 找出遺漏期數最長的尾數
        let tailSorted = lastSeenTail.map((val, idx) => ({tail: idx, missing: val}))
                         .sort((a, b) => b.missing - a.missing);

        let longestMissingTail = tailSorted[0];
        
        // --- 3. 顯示分析結果 ---
        const tailDiv = document.getElementById('tailAnalysis');
        tailDiv.innerHTML = `
            <p>目前最久沒開出的尾數是：<span class="highlight">${longestMissingTail.tail} 尾</span></p>
            <p>已連續遺漏 <span class="highlight">${longestMissingTail.missing} 期</span> 未現身。</p>
            <p>該尾數推薦號碼：</p>
        `;

        // 推薦該尾數的所有號碼
        let recommend = [];
        for(let i=1; i<=39; i++) {
            if(i % 10 === longestMissingTail.tail) recommend.push(i);
        }
        displayBalls('tailRecommend', recommend, 'ball tail-ball');
    }

    function displayBalls(id, nums, className) {
        const container = document.getElementById(id);
        container.innerHTML = '';
        nums.forEach(n => {
            const b = document.createElement('div');
            b.className = className;
            b.innerText = n.toString().padStart(2, '0');
            container.appendChild(b);
        });
    }
</script>

</body>
</html>
