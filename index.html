<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 Strategy AI: Dynamic Heatmap</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #030712; --card: #111827; --accent: #38bdf8; --hot: #ef4444; --gold: #fbbf24; --success: #10b981; --con: #8b5cf6; }
        body { margin: 0; background: var(--bg); color: #f1f5f9; font-family: system-ui, sans-serif; padding: 10px; font-size: 13px; }
        .dashboard { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 1fr 520px; gap: 12px; }
        .panel { background: var(--card); border-radius: 12px; padding: 16px; border: 1px solid #1f2937; }
        .full { grid-column: 1 / -1; }
        
        /* 視覺看板 */
        .chart-box { height: 220px; margin-top: 10px; }

        /* 動態球盤 */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(82px, 1fr)); gap: 10px; }
        .ball { 
            aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.3s; position: relative; background: #1f2937; border: 1px solid #374151; overflow: hidden;
        }
        .ball .num { font-size: 20px; font-weight: 900; z-index: 2; transition: 0.3s; }
        .ball:hover .num { transform: scale(1.2); }
        
        /* 熱度與漏期動畫漸層 */
        .heat-bg { position: absolute; inset: 0; opacity: 0.2; transition: 0.5s; }
        .gap-pulse { position: absolute; bottom: 0; left: 0; height: 4px; background: var(--accent); transition: width 1s ease-in-out; }
        .con-glow { position: absolute; right: 0; top: 0; width: 4px; height: 100%; background: var(--con); opacity: 0.5; }

        /* 方案分級列表 */
        .plan-card { background: #1e293b; padding: 12px; border-radius: 10px; border: 1px solid #334155; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .plan-nums { display: flex; gap: 5px; }
        .p-num { width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 13px; background: #0f172a; }
        .p-num.hot { border: 1px solid var(--hot); color: var(--hot); }
        
        .score-box { text-align: right; }
        .rank-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        .btn-ai { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--accent), var(--con)); border: none; color: white; border-radius: 10px; font-weight: 800; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="panel full">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <h3 style="margin:0">戰略指揮中心 (和值趨勢與熱點回測)</h3>
            <input type="file" onchange="init(this)">
        </div>
        <div class="chart-box"><canvas id="mainChart"></canvas></div>
    </div>

    <div class="panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px">
            <b>動態權重球盤 (底條:漏期 | 背景:命中熱度)</b>
            <span id="ai-status" style="color:var(--gold)">等待數據...</span>
        </div>
        <div id="grid" class="grid"></div>
    </div>

    <div class="panel">
        <h3 style="margin:0">AI 策略生成 (附穩定性評分)</h3>
        <button class="btn-ai" onclick="generateTactics()">執行多組策略生成與方案驗證</button>
        <div id="plan-list"></div>
    </div>
</div>

<script>
    let db = [], scores = {}, stats = { freq: {}, gap: {}, con: {} }, chart;

    function init(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.trim().split('\n').slice(1);
            stats.freq = {}; stats.gap = {}; stats.con = {};
            for(let i=1; i<=39; i++) stats.gap[i] = lines.length;

            db = lines.map((l, idx) => {
                const c = l.split(',');
                const nums = c.slice(1,6).map(Number).sort((a,b)=>a-b);
                nums.forEach((n, i) => {
                    stats.freq[n] = (stats.freq[n]||0)+1;
                    if(stats.gap[n] > idx) stats.gap[n] = idx;
                    if(i > 0 && nums[i]-nums[i-1] === 1) stats.con[n] = (stats.con[n]||0)+1;
                });
                return { date: c[0].slice(5), nums, sum: nums.reduce((a,b)=>a+b,0) };
            }).reverse();

            calcAI();
            renderGrid();
            renderChart();
        };
        reader.readAsText(input.files[0]);
    }

    function calcAI() {
        for(let i=1; i<=39; i++) {
            scores[i] = (stats.freq[i]||0)*2 + (stats.gap[i]||0)*1.5 + (stats.con[i]||0)*1.2;
        }
        document.getElementById('ai-status').innerText = `✅ AI 權重已更新`;
    }

    function renderGrid() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        const maxFreq = Math.max(...Object.values(stats.freq)), maxGap = Math.max(...Object.values(stats.gap));

        for(let i=1; i<=39; i++) {
            const ball = document.createElement('div');
            const heat = (stats.freq[i]/maxFreq);
            const gapPer = (stats.gap[i]/maxGap)*100;
            
            ball.className = 'ball';
            ball.innerHTML = `
                <div class="heat-bg" style="background:var(--hot); opacity:${heat * 0.5}"></div>
                <div class="gap-pulse" style="width:${gapPer}%"></div>
                ${stats.con[i] ? `<div class="con-glow"></div>` : ''}
                <span class="num">${String(i).padStart(2,'0')}</span>
                <span style="font-size:8px; opacity:0.5; z-index:2">開:${stats.freq[i]}|漏:${stats.gap[i]}</span>
            `;
            grid.appendChild(ball);
        }
    }

    function generateTactics() {
        const list = document.getElementById('plan-list'); list.innerHTML = '';
        const top10 = Object.entries(scores).sort((a,b)=>b[1]-a[1]).slice(0, 10).map(x=>Number(x[0]));
        
        let pool = [];
        Object.entries(scores).forEach(([n, s]) => { for(let k=0; k<Math.floor(s); k++) pool.push(Number(n)); });

        let results = [];
        for(let g=0; g<5; g++) {
            let temp = new Set();
            while(temp.size < 5) temp.add(pool[Math.floor(Math.random()*pool.length)]);
            let arr = Array.from(temp).sort((a,b)=>a-b);
            
            // 穩定性計算 (10/30/50期命中率)
            const depths = [10, 30, 50];
            const hits = depths.map(d => {
                let h = 0;
                db.slice(-d).forEach(past => h += past.nums.filter(n => arr.includes(n)).length);
                return (h / d).toFixed(2);
            });
            const stability = (hits[0]*0.5 + hits[1]*0.3 + hits[2]*0.2).toFixed(2);
            results.push({ arr, hits, stability });
        }

        results.sort((a,b) => b.stability - a.stability).forEach((res, i) => {
            const card = document.createElement('div');
            card.className = 'plan-card';
            card.innerHTML = `
                <div>
                    <div class="plan-nums">${res.arr.map(n => `<div class="p-num ${top10.includes(n)?'hot':''}">${String(n).padStart(2,'0')}</div>`).join('')}</div>
                    <div style="font-size:10px; color:#94a3b8; margin-top:5px">核心號佔比: ${res.arr.filter(n=>top10.includes(n)).length}/5</div>
                </div>
                <div class="score-box">
                    <span class="rank-tag" style="background:${i===0? 'var(--gold)':'#334155'}; color:#000">${i===0? '最穩定推薦':'方案 '+(i+1)}</span>
                    <div style="color:var(--success); font-weight:bold; margin-top:4px">評分: ${res.stability}</div>
                    <div style="font-size:9px; opacity:0.5">10期命中: ${res.hits[0]}</div>
                </div>
            `;
            list.appendChild(card);
        });
    }

    function renderChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        const data = db.slice(-25);
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: data.map(d=>d.date), datasets: [{ label: '和值趨勢', data: data.map(d=>d.sum), borderColor: '#fbbf24', tension: 0.3, fill: true, backgroundColor: 'rgba(251, 191, 36, 0.1)' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>
