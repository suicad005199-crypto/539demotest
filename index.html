<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>539 QUANT ENGINE · Deterministic</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background:#0f172a;
  color:#e5e7eb;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Microsoft JhengHei",sans-serif;
  margin:0; padding:30px;
}
.container{max-width:1200px;margin:auto}
h1{color:#38bdf8;margin-bottom:5px}
.sub{color:#94a3b8;margin-bottom:25px}
.card{
  background:#1e293b;
  border-radius:14px;
  padding:20px;
  margin-bottom:25px;
}
button{
  background:#38bdf8;color:#0f172a;
  border:none;padding:12px 26px;
  font-weight:700;border-radius:8px;
  cursor:pointer
}
.ball{
  display:inline-block;
  width:34px;height:34px;
  line-height:34px;
  text-align:center;
  border-radius:50%;
  background:#334155;
  margin:2px;
  font-weight:700;
}
.strategy{margin-top:20px;border-top:1px solid rgba(255,255,255,.1);padding-top:20px}
.pickRow{
  display:flex;align-items:center;gap:14px;
  padding:12px;margin:10px 0;
  background:rgba(255,255,255,.03);
  border-radius:10px
}
.good{border:1px solid #22c55e}
.badge{
  background:#38bdf8;color:#0f172a;
  padding:4px 10px;border-radius:6px;
  font-size:.75rem;font-weight:700
}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
th{color:#94a3b8;text-align:left}
canvas{max-height:320px}
</style>
</head>

<body>
<div class="container">
<h1>539 QUANT ENGINE</h1>
<div class="sub">Deterministic · Rolling Backtest · No Random</div>

<div class="card">
<input type="file" id="csvFile" accept=".csv">
<button onclick="run()">執行量化回測</button>
</div>

<div class="card" id="history"></div>
<div class="card" id="kpi"></div>
<div class="card" id="results"></div>
<div class="card">
<canvas id="chart"></canvas>
</div>
</div>

<script>
/* ================= 基本設定 ================= */
const RULES = [
 {name:"Alpha 保守", pool:"last1+5"},
 {name:"Beta 均衡", pool:"last5+5+10"},
 {name:"Gamma 進取", pool:"last5+10"}
];

/* ================= 主流程 ================= */
async function run(){
 const file=document.getElementById("csvFile").files[0];
 if(!file){alert("請上傳 CSV");return;}
 const text=await file.text();
 const data=parseCSV(text);

 showHistory(data);
 const stats=RULES.map(r=>backtest(data,r));
 renderKPI(stats);
 renderResults(data,stats);
 drawChart(stats);
}

/* ================= CSV ================= */
function parseCSV(t){
 const l=t.trim().split("\n");l.shift();
 return l.map(r=>{
   const p=r.split(",");
   return{date:p[0],nums:p.slice(2,7).map(Number)};
 });
}

/* ================= 量化核心 ================= */
function generateQuantPick(train,rule){
 const pool=buildPool(train.slice(-5),rule);
 const freq={},rec={},trans={};

 train.forEach(d=>d.nums.forEach(n=>freq[n]=(freq[n]||0)+1));
 [...train].reverse().forEach((d,i)=>d.nums.forEach(n=>rec[n]??=(i+1)));

 for(let i=0;i<train.length-1;i++){
  train[i].nums.forEach(a=>{
   trans[a]??={};
   train[i+1].nums.forEach(b=>trans[a][b]=(trans[a][b]||0)+1);
  });
 }

 const last=train.at(-1).nums;
 const scored=pool.map(n=>{
  let t=0;last.forEach(l=>t+=(trans[l]?.[n]||0));
  return{
   n,
   s:(freq[n]||0)/train.length*0.45 +
     (rec[n]?1/rec[n]:0)*0.35 +
     t*0.2
  };
 });

 scored.sort((a,b)=>b.s-a.s||a.n-b.n);
 return scored.slice(0,5).map(x=>x.n).sort((a,b)=>a-b);
}

/* ================= 回測 ================= */
function backtest(data,rule){
 let h2=0,h3=0,t=0;
 for(let i=50;i<data.length;i++){
  const train=data.slice(i-50,i);
  const pick=generateQuantPick(train,rule);
  const hit=data[i].nums.filter(n=>pick.includes(n)).length;
  t++; if(hit>=2)h2++; if(hit>=3)h3++;
 }
 return{rule,hit2:h2/t,hit3:h3/t};
}

/* ================= 輔助 ================= */
function buildPool(latest,rule){
 const s=new Set();
 if(rule.pool.includes("last1"))latest.at(-1).nums.forEach(n=>s.add(n));
 if(rule.pool.includes("last5"))latest.forEach(d=>d.nums.forEach(n=>s.add(n)));
 [...s].forEach(n=>{
  if(rule.pool.includes("+5")&&n+5<=39)s.add(n+5);
  if(rule.pool.includes("+10")&&n+10<=39)s.add(n+10);
 });
 return [...s];
}

/* ================= 顯示 ================= */
function showHistory(d){
 document.getElementById("history").innerHTML=
 "<h3>最近 5 期</h3>"+
 d.slice(-5).map(x=>x.nums.map(n=>`<span class="ball">${n}</span>`).join("")).join("<br>");
}

function renderKPI(s){
 document.getElementById("kpi").innerHTML=
 "<h3>回測勝率</h3><table>"+
 s.map(x=>`<tr><td>${x.rule.name}</td><td>中2 ${(x.hit2*100).toFixed(1)}%</td><td>中3 ${(x.hit3*100).toFixed(1)}%</td></tr>`).join("")+
 "</table>";
}

function renderResults(data,stats){
 const r=document.getElementById("results");
 r.innerHTML="<h3>回測後最佳組合</h3>";
 stats.forEach(s=>{
  const picks=[];
  for(let i=0;i<3;i++){
   const p=generateQuantPick(data.slice(-60+i),s.rule);
   const h2=data.filter(d=>d.nums.filter(n=>p.includes(n)).length>=2).length/data.length;
   picks.push({p,h2});
  }
  picks.sort((a,b)=>b.h2-a.h2);
  r.innerHTML+=`<div class="strategy"><b>${s.rule.name}</b>`+
   picks.map((x,i)=>`
    <div class="pickRow ${x.h2>=0.5?"good":""}">
     #${i+1}
     ${x.p.map(n=>`<span class="ball">${n}</span>`).join("")}
     <span class="badge">${(x.h2*100).toFixed(1)}%</span>
    </div>`).join("")+
   "</div>";
 });
}

function drawChart(s){
 new Chart(document.getElementById("chart"),{
  type:"bar",
  data:{
   labels:s.map(x=>x.rule.name),
   datasets:[
    {label:"中2",data:s.map(x=>x.hit2*100),backgroundColor:"#38bdf8"},
    {label:"中3",data:s.map(x=>x.hit3*100),backgroundColor:"#22c55e"}
   ]
  },
  options:{scales:{y:{beginAtZero:true,max:100}}}
 });
}
</script>
</body>
</html>
