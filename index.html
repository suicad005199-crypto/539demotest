<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 ≥4 主目標｜盤型篩選強攻版</title>
<style>
body { font-family: Arial; padding: 20px; }
button { padding: 8px 16px; margin: 10px 0; }
</style>
</head>
<body>

<h2>539 ≥4 主目標（只打高度共振盤）</h2>

<input type="file" id="csvFile" accept=".csv">
<br>
<button onclick="runBacktest()">執行回測</button>

<div id="output"></div>

<script>
function parseCSV(text){
  return text.trim().split("\n").slice(1)
    .map(r => r.split(",").slice(1).map(Number));
}

function runBacktest(){
  const file = document.getElementById("csvFile").files[0];
  if(!file) return alert("請上傳 CSV");

  const reader = new FileReader();
  reader.onload = () => {
    const draws = parseCSV(reader.result);

    let total=0, played=0;
    let hit2=0, hit3=0, hit4=0;

    for(let i=30;i<draws.length;i++){
      total++;
      const history = draws.slice(0,i);
      const actual  = draws[i];

      // === Gap ===
      const gap={}; for(let n=1;n<=39;n++) gap[n]=0;
      history.forEach(d=>{
        for(let n=1;n<=39;n++) gap[n]++;
        d.forEach(n=>gap[n]=0);
      });

      // === 熱號（近5期 ≥3次）===
      const f5={};
      history.slice(-5).forEach(d=>d.forEach(n=>f5[n]=(f5[n]||0)+1));
      const hot = Object.keys(f5).filter(n=>f5[n]>=3).map(Number);

      // === 極冷 ===
      const cold = Object.keys(gap).filter(n=>gap[n]>=18).map(Number);

      // === 盤型門檻 ===
      const recent2 = history.slice(-2).flat();
      const hotOverlap = hot.filter(n=>recent2.includes(n)).length;
      if(!(hotOverlap>=3 && cold.length>=2)) continue;

      played++;

      // === 產生 12 組（主打 4熱1冷，補 3熱2冷）===
      const preds=[];

      // 4熱1冷
      for(let a=0;a<hot.length && preds.length<12;a++){
        for(let b=a+1;b<hot.length;b++){
          for(let c=b+1;c<hot.length;c++){
            for(let d=c+1;d<hot.length;d++){
              for(let e=0;e<cold.length;e++){
                const p=[hot[a],hot[b],hot[c],hot[d],cold[e]];
                if(new Set(p).size!==5) continue;
                preds.push(p);
                if(preds.length>=12) break;
              }
              if(preds.length>=12) break;
            }
            if(preds.length>=12) break;
          }
          if(preds.length>=12) break;
        }
      }

      // 3熱2冷（補）
      if(preds.length<12){
        for(let a=0;a<hot.length && preds.length<12;a++){
          for(let b=a+1;b<hot.length;b++){
            for(let c=b+1;c<hot.length;c++){
              for(let d=0;d<cold.length;d++){
                for(let e=d+1;e<cold.length;e++){
                  const p=[hot[a],hot[b],hot[c],cold[d],cold[e]];
                  if(new Set(p).size!==5) continue;
                  preds.push(p);
                  if(preds.length>=12) break;
                }
                if(preds.length>=12) break;
              }
              if(preds.length>=12) break;
            }
            if(preds.length>=12) break;
          }
        }
      }

      let m2=false,m3=false,m4=false;
      preds.forEach(p=>{
        const h=p.filter(n=>actual.includes(n)).length;
        if(h>=2) m2=true;
        if(h>=3) m3=true;
        if(h>=4) m4=true;
      });

      if(m2) hit2++;
      if(m3) hit3++;
      if(m4) hit4++;
    }

    document.getElementById("output").innerHTML = `
      <b>總期數：</b> ${total}<br>
      <b>出手期數：</b> ${played}（${(played/total*100).toFixed(1)}%）<br><br>
      <b>出手期 ≥2：</b> ${played? (hit2/played*100).toFixed(1):0}%<br>
      <b>出手期 ≥3：</b> ${played? (hit3/played*100).toFixed(1):0}%<br>
      <b style="font-size:18px">出手期 ≥4：</b>
      <b style="font-size:18px">${played? (hit4/played*100).toFixed(1):0}%</b>
    `;
  };
  reader.readAsText(file);
}
</script>

</body>
</html>
