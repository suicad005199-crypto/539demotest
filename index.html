<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>三星-預測系統 v4.0 (十萬次頻率聚合)</title>
<style>
:root {
  --primary: #00ff99;
  --bg-0: #050b15;
  --bg-1: #0f1f38;
  --text-light: #e0f7ff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0b1626; color: var(--text-light); padding: 20px;
}
.container { max-width: 600px; margin: 0 auto; }
.header { text-align: center; padding: 20px; background: var(--bg-0); border-radius: 15px; margin-bottom: 20px; border-top: 4px solid var(--primary); }
.panel { border-radius: 16px; padding: 20px; margin-bottom: 20px; background: var(--bg-1); border: 1px solid rgba(255,255,255,0.05); }
.btn { width: 100%; padding: 18px; border-radius: 12px; font-size: 16px; cursor: pointer; border: none; font-weight: bold; transition: 0.3s; }
.btn-primary { background: var(--primary); color: #000; box-shadow: 0 4px 15px rgba(0,255,153,0.3); }
.number-ball { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; background: #203f6e; color: #fff; }
.number-ball.best { background: linear-gradient(135deg, var(--primary), #00cc7a); color: #000; }
.numbers-grid { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
.status { padding: 12px; border-radius: 8px; font-size: 0.9rem; background: rgba(0,255,153,0.1); color: var(--primary); border: 1px solid var(--primary); text-align: center; line-height: 1.6; }
.loading { display: none; text-align: center; margin: 15px 0; color: var(--primary); font-weight: bold; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>三星-預測系統 v4.0</h1>
    <p>純頻率權重 | 十萬次大規模模擬</p>
  </div>

  <div class="panel">
    <input type="file" id="csvInput" style="color:#fff; margin-bottom:10px;" accept=".csv">
    <div id="csvInfo"></div>
  </div>

  <div class="panel">
    <button class="btn btn-primary" onclick="generateUltraPrediction()">執行十萬次聚合預測</button>
    <div class="loading" id="loader">
      <div style="margin-bottom:10px;">正在進行 100,000 次蒙地卡羅運算...</div>
      <div id="progress">0%</div>
    </div>
    <div id="resultArea" style="display: none;">
      <div class="numbers-grid" id="bestNumbers"></div>
      <div class="status" id="bestStatus"></div>
    </div>
  </div>
</div>

<script>
let data = [];
let stats = null;

document.getElementById("csvInput").onchange = function(e) {
  const reader = new FileReader();
  reader.onload = (ev) => {
    const lines = ev.target.result.trim().split(/\r?\n/);
    data = lines.slice(1).map(l => ({ numbers: l.split(",").slice(1, 6).map(n => parseInt(n)) }));
    calculateGlobalStats();
    document.getElementById("csvInfo").innerHTML = `<div class="status">數據載入成功：共 ${data.length} 期</div>`;
  };
  reader.readAsText(e.target.files[0]);
};

function calculateGlobalStats() {
  const freq = {};
  const sums = [];
  data.forEach(d => {
    d.numbers.forEach(n => freq[n] = (freq[n] || 0) + 1);
    sums.push(d.numbers.reduce((a, b) => a + b, 0));
  });
  stats = { freq, total: data.length, avgSum: sums.reduce((a,b)=>a+b,0)/sums.length };
}

function generateUltraPrediction() {
  if (!data.length) return alert("請導入 CSV 數據");
  const loader = document.getElementById("loader");
  const resultArea = document.getElementById("resultArea");
  loader.style.display = "block";
  resultArea.style.display = "none";

  // 10萬次模擬較耗時，分段執行避免 UI 凍結
  setTimeout(() => {
    const SIM_COUNT = 100000;
    let globalCounter = Array(40).fill(0);
    
    // 1. 純頻率權重 (移除遺漏加分)
    const pool = [];
    for(let i=1; i<=39; i++) {
      const score = (stats.freq[i] || 0) / stats.total;
      pool.push({num: i, score});
    }

    // 2. 十萬次模擬聚合
    let validCount = 0;
    for(let s=0; s<SIM_COUNT; s++) {
      let pick = [];
      let tempPool = [...pool];
      for(let i=0; i<5; i++) {
        let totalW = tempPool.reduce((sum, c) => sum + c.score, 0);
        let rand = Math.random() * totalW;
        let acc = 0;
        for(let j=0; j<tempPool.length; j++) {
          acc += tempPool[j].score;
          if(rand <= acc) { pick.push(tempPool[j].num); tempPool.splice(j,1); break; }
        }
      }

      const sum = pick.reduce((a,b)=>a+b, 0);
      const odd = pick.filter(n => n%2!==0).length;
      
      // 嚴格篩選符合歷史常態的樣本 (和值 ±10, 2奇或3奇)
      if(Math.abs(sum - stats.avgSum) <= 10 && (odd === 2 || odd === 3)) {
        pick.forEach(n => globalCounter[n]++);
        validCount++;
      }
    }

    // 3. 取前 7 名高頻號碼作為「黃金池」
    const goldenPool = globalCounter
      .map((c, n) => ({n, c}))
      .sort((a, b) => b.c - a.c)
      .slice(0, 7)
      .map(x => x.n);

    // 4. 小範圍隨機調整 (從 7 名中隨機選 5 名)
    let finalSelection = [];
    let tempGolden = [...goldenPool];
    for(let i=0; i<5; i++) {
      const idx = Math.floor(Math.random() * tempGolden.length);
      finalSelection.push(tempGolden.splice(idx, 1)[0]);
    }
    finalSelection.sort((a,b) => a - b);

    // 5. 渲染結果
    document.getElementById("bestNumbers").innerHTML = finalSelection.map(n => `<div class="number-ball best">${n}</div>`).join('');
    document.getElementById("bestStatus").innerHTML = `
      <b>十萬次聚合模擬完成</b><br>
      有效樣本數：${validCount} 組<br>
      已從前 7 名高頻共識號碼中隨機生成最優組合
    `;
    
    loader.style.display = "none";
    resultArea.style.display = "block";
  }, 100);
}
</script>
</body>
</html>
