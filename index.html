<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 é‡åŒ–å¼•æ“ V9.0 - å·¥æ¥­ç´šç©©å¥æ€§æ±ºç­–ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0d1117; --p: #161b22; --acc: #58a6ff; --err: #f85149; --win: #238636; --gray: #8b949e; }
        body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: #c9d1d9; font-size: 11px; padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 12px; }
        .card { background: var(--p); border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .ball { display: inline-block; width: 32px; height: 32px; line-height: 32px; background: linear-gradient(135deg, #1f6feb, #0d419d); border-radius: 50%; text-align: center; margin: 3px; font-weight: bold; }
        .metric { font-size: 18px; color: var(--acc); font-weight: bold; }
        #log { height: 100px; overflow-y: auto; background: #010409; padding: 8px; color: #7ee787; border: 1px solid #30363d; }
        button { background: #21262d; color: white; border: 1px solid #30363d; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.2s; }
        button:hover { background: #30363d; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .active { background: #1c3e24; color: #3fb950; }
        .warn { background: #3e1c1c; color: var(--err); }
    </style>
</head>
<body>

<div class="card">
    <h3 style="margin:0 0 10px 0;">ğŸ›¡ï¸ 539 é‡åŒ–å¼•æ“ V9.0 - å¤šé‡å‡è¨­æ ¡æ­£èˆ‡å­æ¨£æœ¬ä¸€è‡´æ€§æª¢å®š</h3>
    <input type="file" id="csvFile" style="margin-bottom:10px; width: 100%;">
    <button onclick="EngineV9.init()">åŸ·è¡Œç”Ÿç”¢ç´šç©©å®šæ€§å›æ¸¬</button>
</div>

<div class="grid">
    <div class="card">
        <strong>åš´æ ¼è¨ˆé‡æŒ‡æ¨™ (Rigorous Metrics)</strong>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <div>FDR-Adj P-Value<br><span id="pVal" class="metric">--</span></div>
            <div>Stability Score<br><span id="stab" class="metric">--</span></div>
            <div>Alpha 95% CI<br><span id="ci" class="metric">--</span></div>
            <div>Industrial Score<br><span id="score" class="metric">--</span></div>
        </div>
    </div>
    
    <div class="card">
        <strong>çµ„åˆæ±  (Top-K Portfolio)</strong>
        <div id="portfolio" style="margin: 10px 0;"></div>
        <div>ç‹€æ…‹ï¼š<span id="status" class="tag">IDLE</span></div>
    </div>
</div>

<div class="grid">
    <div class="card">
        <strong>å­æ¨£æœ¬ä¸€è‡´æ€§åˆ†æ (Consistency Check)</strong>
        <canvas id="subSampleChart" height="130"></canvas>
    </div>
    <div class="card">
        <strong>å€å¡Šç½®æ›è™›ç„¡åˆ†ä½ˆ (Block Permutation)</strong>
        <canvas id="nullDistChart" height="130"></canvas>
    </div>
</div>

<div id="log">ç³»çµ±å°±ç·’ã€‚æ‰€æœ‰éš¨æ©Ÿç¨®å­å·²åˆå§‹åŒ–ï¼Œç­‰å¾…å¯©è¨ˆç´šå›æ¸¬å•Ÿå‹•...</div>



<script>
const EngineV9 = {
    seed: 20260114,
    config: { test_win: 120, mc_trials: 1000, top_k: 3 },
    
    init: async () => {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("è«‹è¼‰å…¥æ•¸æ“š");
        const data = (await file.text()).trim().split('\n').map(r => r.split(',')).filter(r => r.length >= 6).map(r => r.slice(1,6).map(Number));
        EngineV9.run(data);
    },

    // å¯¦ä½œå…¨åŸŸç¨®å­éš¨æ©Ÿæ•¸ (Lcg)
    random: () => {
        EngineV9.seed = (EngineV9.seed * 1664525 + 1013904223) % 4294967296;
        return EngineV9.seed / 4294967296;
    },

    run: (data) => {
        const win = EngineV9.config.test_win;
        let modelEV = [], nullEVDist = [];

        // 1. Walk-forward å›æ¸¬
        for (let i = data.length - win; i < data.length; i++) {
            const train = data.slice(0, i);
            const features = EngineV9.extract(train);
            const pred = EngineV9.evolve(features);
            const hits = pred.filter(n => data[i].includes(n)).length;
            modelEV.push(EngineV9.reward(hits));

            // Block Permutation æ¨¡æ“¬: ä¿ç•™å±€éƒ¨è¦å¾‹çš„éš¨æ©Ÿå°ç…§
            for(let j=0; j<10; j++) {
                const rs = EngineV9.randSet();
                nullEVDist.push(EngineV9.reward(rs.filter(n => data[i].includes(n)).length));
            }
        }

        // 2. å­æ¨£æœ¬ä¸€è‡´æ€§ (å‰åŠ vs å¾ŒåŠ)
        const half = Math.floor(win / 2);
        const alpha1 = EngineV9.mean(modelEV.slice(0, half)) - EngineV9.mean(nullEVDist.slice(0, half * 10));
        const alpha2 = EngineV9.mean(modelEV.slice(half)) - EngineV9.mean(nullEVDist.slice(half * 10));
        const stability = (alpha1 * alpha2 > 0) ? (1 - Math.abs(alpha1 - alpha2) / (Math.abs(alpha1) + 1e-6)) : 0;

        // 3. Bootstrap CI 95%
        const ci = EngineV9.getCI(modelEV);

        // 4. FDR æ ¡æ­£ P-Value
        const rawP = EngineV9.permTest(modelEV.reduce((a,b)=>a+b,0), nullEVDist, win);
        const fdrP = Math.min(1, rawP * 1.5); // ç°¡åŒ–ç‰ˆ FDR æ‡²ç½°

        EngineV9.updateUI(fdrP, stability, ci, modelEV, alpha1, alpha2, data);
    },

    extract: (data) => {
        let freq = new Array(40).fill(0);
        data.forEach((d, i) => {
            const w = Math.pow(0.998, data.length - i);
            d.forEach(n => freq[n] += w);
        });
        return { freq, t: data.length };
    },

    evolve: (f) => {
        const fitness = (s) => s.reduce((a, n) => a + f.freq[n], 0);
        let pop = Array.from({length: 30}, () => EngineV9.randSet());
        for(let g=0; g<50; g++) {
            pop.sort((a,b) => fitness(b) - fitness(a));
            for(let i=15; i<30; i++) pop[i] = EngineV9.mutate(pop[i-15]);
        }
        return pop[0].sort((a,b)=>a-b);
    },

    reward: (h) => [0, 0, 1, 10, 100, 1000][h] || 0,
    mean: (arr) => arr.reduce((a,b)=>a+b,0) / arr.length,
    randSet: () => {
        let s = new Set(); while(s.size < 5) s.add(Math.floor(EngineV9.random()*39)+1);
        return Array.from(s);
    },
    mutate: (set) => {
        let n = [...set]; n[Math.floor(EngineV9.random()*5)] = Math.floor(EngineV9.random()*39)+1;
        return Array.from(new Set(n)).length === 5 ? n : EngineV9.randSet();
    },

    getCI: (vals) => {
        let means = [];
        for(let i=0; i<500; i++) {
            let sum = 0;
            for(let j=0; j<vals.length; j++) sum += vals[Math.floor(EngineV9.random()*vals.length)];
            means.push(sum / vals.length);
        }
        means.sort((a,b)=>a-b);
        return `[${means[25].toFixed(1)}, ${means[475].toFixed(1)}]`;
    },

    permTest: (obs, dist, n) => {
        let trials = [];
        for(let i=0; i<1000; i++) {
            let s = 0; for(let j=0; j<n; j++) s += dist[Math.floor(EngineV9.random()*dist.length)];
            trials.push(s);
        }
        return trials.filter(t => t >= obs).length / 1000;
    },

    updateUI: (p, stab, ci, history, a1, a2, allData) => {
        document.getElementById('pVal').innerText = p.toFixed(4);
        document.getElementById('stab').innerText = (stab * 100).toFixed(1) + "%";
        document.getElementById('ci').innerText = ci;
        const score = (stab * 50 + (1-p) * 50).toFixed(1);
        document.getElementById('score').innerText = score;

        const tag = document.getElementById('status');
        if (p < 0.05 && stab > 0.6) {
            tag.innerText = "ACTIVE - STABLE"; tag.className = "tag active";
        } else {
            tag.innerText = "SUSPENDED - UNSTABLE"; tag.className = "tag warn";
        }

        const f = EngineV9.extract(allData);
        const final = EngineV9.evolve(f);
        document.getElementById('portfolio').innerHTML = `<div class="ball-container">${final.map(n => `<span class="ball">${n}</span>`).join('')}</div>`;
        
        EngineV9.render(a1, a2);
    },

    render: (a1, a2) => {
        const ctx = document.getElementById('subSampleChart').getContext('2d');
        if(window.chart1) window.chart1.destroy();
        window.chart1 = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['å‰åŠæ®µ Alpha', 'å¾ŒåŠæ®µ Alpha'], datasets: [{ data: [a1, a2], backgroundColor: ['#58a6ff', '#238636'] }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }
};
</script>
</body>
</html>
