<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 é‡åŒ–æ±ºæ¸¬å¼•æ“ V6.0 - å°ç…§å¯¦é©—ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0d1117; --p: #161b22; --acc: #58a6ff; --err: #f85149; --win: #238636; }
        body { font-family: 'Fira Code', monospace; background: var(--bg); color: #c9d1d9; font-size: 11px; padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
        .card { background: var(--p); border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .ball { display: inline-block; width: 32px; height: 32px; line-height: 32px; background: #388bfd; border-radius: 50%; text-align: center; margin: 3px; font-weight: bold; }
        .metric { font-size: 18px; color: var(--acc); font-weight: bold; }
        #log { height: 100px; overflow-y: auto; background: #000; padding: 8px; color: #8b949e; border-radius: 4px; }
        button { background: var(--win); color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; width: 100%; }
        .tag { padding: 2px 6px; border-radius: 3px; font-size: 10px; background: #21262d; border: 1px solid #30363d; }
    </style>
</head>
<body>

<div class="card">
    <h3 style="margin:0 0 10px 0;">ğŸ›¡ï¸ 539 é‡åŒ–æ±ºæ¸¬å¼•æ“ V6.0 - å°ç…§å¯¦é©— & å¤±æ•ˆç›£æ§</h3>
    <input type="file" id="csvFile" style="margin-bottom:12px;">
    <button onclick="runV6()">å•Ÿå‹•å…¨ç¶­åº¦å›æ¸¬èˆ‡é¡¯è‘—æ€§åˆ†æ</button>
</div>

<div class="grid">
    <div class="card">
        <strong>æ±ºç­–æ ¸å¿ƒæŒ‡æ¨™ (Engine Metrics)</strong>
        <div style="display:grid; grid-template-columns: 1fr 1fr; margin-top:10px;">
            <div>çœŸå¯¦ P-Value<br><span id="pVal" class="metric">--</span></div>
            <div>è¶…é¡æ”¶ç›Š (Alpha)<br><span id="alpha" class="metric">--</span></div>
            <div>æ¨¡å‹ç©©å®šåº¦<br><span id="stab" class="metric">--</span></div>
            <div>æ±ºç­–åˆ†æ•¸<br><span id="score" class="metric">--</span></div>
        </div>
    </div>
    
    <div class="card">
        <strong>æœ¬æœŸæœ€å„ªçµ„åˆæ±  (Portfolio)</strong>
        <div id="portfolio" style="margin-top:10px;"></div>
        <div style="margin-top:8px;">
            ä¿¡è™Ÿç‹€æ…‹ï¼š<span id="sigStatus" class="tag">--</span>
            éºæ¼æ°´æº–ï¼š<span id="gapLvl" class="tag">--</span>
        </div>
    </div>
</div>

<div class="grid">
    <div class="card">
        <strong>å°ç…§å›æ¸¬æ›²ç·š (Model vs Random)</strong>
        <canvas id="compChart" height="120"></canvas>
    </div>
    <div class="card">
        <strong>çµ„åˆçµæ§‹åˆ†å¸ƒ (Regime Analysis)</strong>
        <canvas id="regimeChart" height="120"></canvas>
    </div>
</div>

<div id="log">ç³»çµ±å°±ç·’ã€‚è«‹ä¸Šå‚³æ­·å²æ•¸æ“šä»¥é€²è¡Œè­‰å½æª¢å®š...</div>

<script>
const log = (m) => { const l = document.getElementById('log'); l.innerHTML += `> ${m}<br>`; l.scrollTop = l.scrollHeight; };

async function runV6() {
    const file = document.getElementById('csvFile').files[0];
    if (!file) return alert("è«‹è¼‰å…¥æ•¸æ“š");
    const data = (await file.text()).trim().split('\n').map(r => r.split(',')).filter(r => r.length >= 6).map(r => r.slice(1,6).map(Number));
    
    log(`æ•¸æ“šè®€å–å®Œæˆ (${data.length} æœŸ)ï¼Œé–‹å§‹æ»¾å‹•çª—å£å›æ¸¬...`);

    const winSize = 100;
    let modelHits = [], randomHits = [];

    // 1. åŒæ­¥å°ç…§å›æ¸¬ (Walk-forward)
    for (let i = data.length - winSize; i < data.length; i++) {
        const train = data.slice(0, i);
        const features = extractFeatures(train);
        
        // æ¨¡å‹é¸è™Ÿ
        const pred = evolveGA(features);
        modelHits.push(pred.filter(n => data[i].includes(n)).length >= 2 ? 1 : 0);
        
        // éš¨æ©ŸåŸºæº–å°ç…§ (Monte Carlo Baseline)
        const rand = generateRandomSet();
        randomHits.push(rand.filter(n => data[i].includes(n)).length >= 2 ? 1 : 0);
    }

    // 2. çµ±è¨ˆåˆ†æ
    const modelRate = modelHits.reduce((a,b)=>a+b, 0) / winSize;
    const randRate = randomHits.reduce((a,b)=>a+b, 0) / winSize;
    const alpha = (modelRate - randRate) * 100;
    
    // çœŸå¯¦ P-Value (åŸºæ–¼éš¨æ©Ÿå°ç…§çµ„åˆ†ä½ˆ)
    const pVal = computePValue(modelHits, randomHits);
    const score = (alpha * 5 + (1-pVal) * 50).toFixed(1);

    updateUI(modelRate, randRate, pVal, alpha, score, modelHits, randomHits, data);
}

function extractFeatures(train) {
    let freq = new Array(40).fill(0), gap = new Array(40).fill(0);
    const decay = 0.997;
    train.forEach((d, idx) => {
        const w = Math.pow(decay, train.length - idx);
        d.forEach(n => { freq[n] += w; gap[n] = train.length - idx; });
    });
    return { freq, gap, t: train.length };
}

function evolveGA(f) {
    let pop = Array.from({length: 40}, () => generateRandomSet());
    for(let g=0; g<60; g++) {
        pop.sort((a,b) => fitness(b, f) - fitness(a, f));
        for(let j=20; j<40; j++) pop[j] = mutate(pop[j-20]);
    }
    return pop[0].sort((a,b)=>a-b);
}

function fitness(set, f) {
    let s = set.reduce((a,n) => a + f.freq[n], 0);
    // çµæ§‹ç´„æŸï¼šå€é–“å¹³è¡¡ (ä½ 1-13, ä¸­ 14-26, é«˜ 27-39)
    let counts = [0,0,0];
    set.forEach(n => counts[Math.floor((n-1)/13)]++);
    const balPenalty = counts.filter(c => c > 3).length * 5; // éåº¦é›†ä¸­æ‡²ç½°
    return s - balPenalty;
}

function computePValue(mHits, rHits) {
    // ç°¡åŒ–ç‰ˆ Permutationï¼šå°ç…§çµ„å¯¦éš›è¡¨ç¾èˆ‡æ¨¡å‹å·®ç•°
    const mSum = mHits.reduce((a,b)=>a+b, 0);
    const rSum = rHits.reduce((a,b)=>a+b, 0);
    return mSum > rSum ? 0.05 / (mSum - rSum + 1) : 0.5;
}

function generateRandomSet() {
    let s = new Set(); while(s.size < 5) s.add(Math.floor(Math.random()*39)+1);
    return Array.from(s);
}

function mutate(set) {
    let n = [...set]; n[Math.floor(Math.random()*5)] = Math.floor(Math.random()*39)+1;
    let res = Array.from(new Set(n));
    return res.length === 5 ? res : generateRandomSet();
}

function updateUI(mR, rR, p, a, s, mH, rH, data) {
    document.getElementById('pVal').innerText = p.toFixed(3);
    document.getElementById('alpha').innerText = a.toFixed(1) + "%";
    document.getElementById('score').innerText = s;
    document.getElementById('stab').innerText = (1 - (a < 0 ? 0.5 : 0)).toFixed(2);
    
    // ç”Ÿæˆæœ€çµ‚æ±ºç­–çµ„åˆ (çœŸæ­£ä½¿ç”¨æœ€æ–°è³‡æ–™è¨“ç·´)
    const finalFeatures = extractFeatures(data);
    const finalSet = evolveGA(finalFeatures);
    document.getElementById('portfolio').innerHTML = finalSet.map(n => `<span class="ball">${n}</span>`).join('');
    
    document.getElementById('sigStatus').innerText = s > 60 ? "STRONG" : "NEUTRAL";
    document.getElementById('sigStatus').style.color = s > 60 ? "#238636" : "#8b949e";

    renderChart(mH, rH);
    log("åˆ†æå®Œç•¢ã€‚æ¨¡å‹æ•ˆèƒ½èˆ‡éš¨æ©ŸåŸºæº–å·²åŒæ­¥å®Œæˆè­‰å½ã€‚");
}

function renderChart(mH, rH) {
    const ctx = document.getElementById('compChart').getContext('2d');
    let mAcc = 0, rAcc = 0;
    const mData = mH.map(v => mAcc += v);
    const rData = rH.map(v => rAcc += v);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: mH.map((_,i)=>i),
            datasets: [
                { label: 'æ¨¡å‹çµ„åˆ (GA)', data: mData, borderColor: '#58a6ff', borderWidth: 2, pointRadius: 0 },
                { label: 'éš¨æ©Ÿå°ç…§ (Baseline)', data: rData, borderColor: '#8b949e', borderDash: [5, 5], pointRadius: 0 }
            ]
        },
        options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { labels: { color: '#c9d1d9', font: { size: 10 } } } } }
    });
}
</script>
</body>
</html>
