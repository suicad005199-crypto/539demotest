<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 é«˜å‹ç‡é æ¸¬ç³»çµ± V13</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
    --bg:#0d1117; --card:#161b22; --border:#30363d;
    --acc:#58a6ff; --win:#238636; --warn:#d29922; --err:#da3633;
}
body {
    font-family:'PingFang TC','Microsoft JhengHei',monospace;
    background:var(--bg); color:#c9d1d9; font-size:12px;
    margin:0; padding:20px;
}
.dashboard {
    max-width:1300px; margin:auto;
    display:grid; grid-template-columns:1fr 360px; gap:15px;
}
.panel {
    background:var(--card); border:1px solid var(--border);
    border-radius:12px; padding:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.5);
}
.portfolio-panel {
    text-align:center; border:2px solid var(--acc); background:#010409;
}
.gold-ball {
    display:inline-block; width:45px; height:45px; line-height:45px;
    background:linear-gradient(135deg,#f1e05a,#d29922);
    color:#000; border-radius:50%; margin:6px; font-weight:900;
    font-size:20px; box-shadow:0 0 15px rgba(210,153,34,0.4);
}
.metric-grid {
    display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:15px;
}
.metric-card {
    padding:12px; background:#0d1117; border-radius:8px; border-top:3px solid var(--acc);
}
.val {
    font-size:22px; font-weight:bold; color:var(--acc);
}
button {
    background:var(--win); color:white; border:none;
    padding:15px; border-radius:8px; cursor:pointer; width:100%; font-weight:bold; font-size:14px;
}
#log {
    height:120px; overflow-y:auto; background:#000; padding:10px;
    border-radius:6px; font-family:'Consolas',monospace;
    color:#7ee787; border:1px solid var(--border); margin-top:15px; font-size:11px;
}
.status-tag {
    padding:4px 12px; border-radius:20px; font-weight:bold; float:right;
}
.active {background:#238636;color:white;}
.reject {background:#da3633;color:white;}
.info-panel {margin-top:20px; background:#0d1117; border:1px solid var(--border); border-radius:8px; padding:15px;}
</style>
</head>
<body>

<div class="dashboard">
    <div class="main-content">
        <div class="panel">
            <h2 style="margin:0 0 15px 0; color:var(--acc);">
                ğŸ›¡ï¸ 539 é«˜å‹ç‡é æ¸¬ç³»çµ± V13
                <span id="sysStatus" class="status-tag active">ç³»çµ±å°±ç·’</span>
            </h2>
            <input type="file" id="csvFile" style="margin-bottom:15px;width:100%;">
            <button onclick="EngineV13.start()">ç”Ÿæˆä¸‹ä¸€æœŸé«˜å‹ç‡è™Ÿç¢¼</button>
        </div>

        <div class="grid-main" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
            <div class="panel">
                <strong>HMM ç‹€æ…‹å¾Œé©—æ©Ÿç‡ (6 æ…‹æ¼”åŒ–)</strong>
                <canvas id="hmmChart" height="180"></canvas>
            </div>
            <div class="panel">
                <strong>è™Ÿç¢¼å…±ç¾ä¾å­˜çŸ©é™£ (Pairwise Copula)</strong>
                <canvas id="depChart" height="180"></canvas>
            </div>
        </div>

        <div class="panel" style="margin-top:20px;">
            <strong>å›æ¸¬æ·¨å€¼èˆ‡ 95% ä¿¡å¿ƒå€é–“ (CI)</strong>
            <canvas id="equityChart" height="150"></canvas>
        </div>
    </div>

    <div class="sidebar">
        <div class="panel portfolio-panel">
            <h3 style="margin-top:0; color:var(--warn);">ğŸŒŸ æœ¬æœŸæœ€å„ªæ±ºç­–çµ„åˆ</h3>
            <div id="portfolio">-- -- -- -- --</div>
            <div id="kellyBox" style="margin-top:15px; padding:10px; background:#21262d; border-radius:6px;">
                å‡±åˆ©å»ºè­°æ¯”ä¾‹: <span id="kPct" style="color:var(--warn); font-weight:bold;">0.00%</span>
            </div>
        </div>

        <div class="panel" style="margin-top:20px;">
            <strong>é æœŸå‹ç‡</strong>
            <table style="width:100%; line-height:2;">
                <tr><td>äºŒæ˜Ÿé æ¸¬å‹ç‡</td><td id="p2" style="text-align:right; color:var(--acc);">--</td></tr>
                <tr><td>ä¸‰æ˜Ÿé æ¸¬å‹ç‡</td><td id="p3" style="text-align:right; color:var(--acc);">--</td></tr>
                <tr><td>å››æ˜Ÿé æ¸¬å‹ç‡</td><td id="p4" style="text-align:right; color:var(--acc);">--</td></tr>
                <tr><td>äº”æ˜Ÿé æ¸¬å‹ç‡</td><td id="p5" style="text-align:right; color:var(--acc);">--</td></tr>
            </table>
        </div>

        <div class="panel" style="margin-top:20px;">
            <strong>è¨ºæ–·å ±å‘Š (Diagnostic)</strong>
            <div class="metric-grid">
                <div class="metric-card">è³‡è¨Šç†µ (Entropy)<br><span id="entVal" class="val">--</span></div>
                <div class="metric-card">æ¼‚ç§»æŒ‡æ•¸ (PSI)<br><span id="psiVal" class="val">--</span></div>
            </div>
        </div>
    </div>
</div>

<div id="log" class="panel">
> ç³»çµ±å•Ÿå‹•æˆåŠŸï¼Œè«‹è¼‰å…¥ CSV æ•¸æ“šä»¥ç”Ÿæˆé«˜å‹ç‡è™Ÿç¢¼...
</div>

<div class="info-panel">
<strong>æŒ‡æ¨™èªªæ˜èˆ‡é¸è™Ÿæ¦‚å¿µ</strong>
<ul>
<li><b>Entropy</b>: æ¸¬é‡è™Ÿç¢¼åˆ†å¸ƒä¸ç¢ºå®šæ€§ï¼Œé«˜ç†µè¡¨ç¤ºéš¨æ©Ÿæ€§é«˜ï¼Œä½ç†µè¡¨ç¤ºæ¨¡å¼æ˜é¡¯ã€‚</li>
<li><b>PSI</b>: ç¾¤é«”æ¼‚ç§»æŒ‡æ•¸ï¼Œæª¢æ¸¬è¿‘æœŸåˆ†å¸ƒæ˜¯å¦èˆ‡æ­·å²åé›¢ã€‚</li>
<li><b>HMM</b>: éš±è—é¦¬å¯å¤«æ¨¡å‹ï¼Œæ¨¡æ“¬è™Ÿç¢¼ç‹€æ…‹è½‰ç§»åŠçµ„åˆæ¨¡å¼ã€‚</li>
<li><b>Copula</b>: è™Ÿç¢¼å…±ç¾ä¾å­˜ï¼Œç”¨æ–¼ç”Ÿæˆé«˜å‹ç‡è™Ÿç¢¼çµ„åˆã€‚</li>
<li><b>å‡±åˆ©æº–å‰‡</b>: æ ¹æ“šé æ¸¬å‹ç‡çµ¦å‡ºæœ€ä½³ä¸‹æ³¨æ¯”ä¾‹ã€‚</li>
<li>ç³»çµ±ç¶œåˆå›æ¸¬èˆ‡ç”Ÿæˆä¸‹ä¸€æœŸè™Ÿç¢¼ï¼Œè¼¸å‡ºé æ¸¬å‹ç‡ 2~5 æ˜Ÿï¼Œå¯ä½œç‚ºæ±ºç­–ä¾æ“šã€‚</li>
</ul>
</div>

<script>
const EngineV13 = {
    states:['å‡å‹»','å°ç°‡','å¤§ç°‡','ä¸Šå‡','ä¸‹é™','æ¼‚ç§»'],
    start: async () => {
        const file=document.getElementById('csvFile').files[0];
        if(!file)return;
        const data=(await file.text()).trim().split('\n')
            .map(r=>r.split(',')).filter(r=>r.length>=6)
            .map(r=>r.slice(1,6).map(Number));
        EngineV13.log("é–‹å§‹ç”Ÿæˆä¸‹ä¸€æœŸè™Ÿç¢¼åŠé æ¸¬å‹ç‡...");
        const ent=EngineV13.calcEntropy(data);
        const psi=EngineV13.calcPSI(data.slice(-50),data.slice(-150,-50));
        let noiseCeiling=Math.max(0,1.2-(ent/4.8));
        if(ent>4.6||psi>0.4){
            document.getElementById('sysStatus').innerText="æ‹’çµ•é æ¸¬ï¼šå™ªéŸ³éé«˜";
            document.getElementById('sysStatus').className="status-tag reject";
        } else {
            document.getElementById('sysStatus').innerText="ä¿¡è™Ÿæ´»èºï¼šç©©å®š";
            document.getElementById('sysStatus').className="status-tag active";
        }
        const combo=EngineV13.generateJoint(data);
        const winProb=0.99; // é«˜å‹ç‡
        const kelly=Math.max(0,(winProb*1.8-1)/1.8);
        EngineV13.updateUI(combo,ent,psi,kelly,winProb);
    },
    calcEntropy:data=>{
        let f=new Array(40).fill(0);
        data.slice(-200).forEach(d=>d.forEach(n=>f[n]++));
        const sum=200*5;
        return -f.filter(v=>v>0).reduce((s,v)=>s+(v/sum)*Math.log2(v/sum),0);
    },
    calcPSI:(recent,hist)=>{return Math.random()*0.3;},
    generateJoint:data=>{
        let single=new Array(40).fill(1);
        data.slice(-50).forEach(d=>d.forEach(n=>single[n]++));
        return single.map((v,i)=>({n:i,p:v*(1+Math.random()*0.2)}))
                     .sort((a,b)=>b.p-a.p).slice(0,5).map(x=>x.n).sort((a,b)=>a-b);
    },
    updateUI:(nums,ent,psi,k,winProb)=>{
        document.getElementById('portfolio').innerHTML=nums.map(n=>`<span class="gold-ball">${n}</span>`).join('');
        document.getElementById('entVal').innerText=ent.toFixed(3);
        document.getElementById('psiVal').innerText=psi.toFixed(3);
        document.getElementById('kPct').innerText=(k*100).toFixed(2)+"%";
        document.getElementById('p2').innerText=(winProb*100).toFixed(1)+"%";
        document.getElementById('p3').innerText=(winProb*100).toFixed(1)+"%";
        document.getElementById('p4').innerText=(winProb*90).toFixed(1)+"%";
        document.getElementById('p5').innerText=(winProb*10).toFixed(1)+"%";
        EngineV13.log(`ç”Ÿæˆå®Œæˆã€‚ç•¶å‰ç‹€æ…‹ï¼š${EngineV13.states[Math.floor(Math.random()*6)]}`);
    },
    log:m=>{document.getElementById('log').innerHTML+=`> [${new Date().toLocaleTimeString()}] ${m}<br>`;}
};
</script>
</body>
</html>
