async function runAll() {
    const fileInput = document.getElementById("csvFile");
    if (!fileInput.files[0]) { alert("請先載入 CSV 檔"); return; }

    const text = await fileInput.files[0].text();
    const data = parseCSV(text);

    showHistory(data);
    const stats = doBacktest(data);
    renderStatsTable(stats);
    drawTrendChart(stats.map(s=>s.hit2Rate*100), stats.map(s=>s.hit3Rate*100));

    let resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "<h3>智能建議組合 (大數據統計 + 高勝率篩選)</h3>";

    // 計算號碼頻率（全歷史）
    const numFreq = Array(40).fill(0);
    data.forEach(d => d.nums.forEach(n => numFreq[n]++));

    stats.forEach(s => {
        // 建立候選號碼池
        const pool = buildPool(data.slice(-5), s.rule);
        // 計算每個號碼在候選池的熱度
        const poolStats = pool.map(n => ({num:n, freq:numFreq[n]}))
                              .sort((a,b)=>b.freq-a.freq);

        // 生成所有可能 5 碼組合（簡單隨機篩選 50 組）
        let candidates = [];
        for(let i=0;i<50;i++){
            const pick = shuffle(pool).slice(0,5).sort((a,b)=>a-b);
            const hit2 = estimateHitRate(pick, data, 2);
            const hit3 = estimateHitRate(pick, data, 3);
            const hit4 = estimateHitRate(pick, data, 4);
            candidates.push({pick, hit2, hit3, hit4});
        }
        // 排序：平均命中率 (中2+中3)/2 高的優先
        candidates.sort((a,b)=> ((b.hit2+b.hit3)/2)-((a.hit2+a.hit3)/2));

        let sBlock = document.createElement("div");
        sBlock.className = "strategy-block";
        sBlock.innerHTML = `<h4>策略：${s.rule.name} <small style="color:gray; font-weight:normal;">${s.rule.desc}</small></h4>`;

        // 顯示號碼池熱度
        sBlock.innerHTML += `<p style="font-size:12px; color:gray;">候選號碼池熱度：` +
            poolStats.map(n => `<span class="ball" style="background:${n.freq>5?'#28a745':'#e9ecef'}">${String(n.num).padStart(2,'0')}</span>`).join("") +
            `</p>`;

        // 顯示前 5 組高勝率組合
        candidates.slice(0,5).forEach((p,i)=>{
            const avgRate = (p.hit2+p.hit3)/2;
            const isHigh = avgRate >= 0.6;
            let ballsHtml = p.pick.map(n => `<span class="ball">${String(n).padStart(2,'0')}</span>`).join("");
            sBlock.innerHTML += `
                <div style="margin-bottom:10px;" class="${isHigh?'high-rate':''}">
                    <span class="pick-btn">組合 ${i+1}</span>
                    ${ballsHtml}
                    <span class="rate-badge">歷史中2+: ${(p.hit2*100).toFixed(1)}%</span>
                    <span class="rate-badge">歷史中3+: ${(p.hit3*100).toFixed(1)}%</span>
                    <span class="rate-badge">歷史中4+: ${(p.hit4*100).toFixed(1)}%</span>
                    ${isHigh?'<b style="color:#28a745; margin-left:5px;">★ 高期望值</b>':''}
                </div>`;
        });
        resultsDiv.appendChild(sBlock);
    });
}
