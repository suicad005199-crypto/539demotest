<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸‰æ˜Ÿ-é æ¸¬ç³»çµ± v2.1 (åŠ æ¬Šå„ªåŒ–ç‰ˆ)</title>
<style>
:root {
  --primary: #00ff99;
  --secondary: #274c77;
  --danger: #ff6666;
  --warning: #ffcc00;
  --bg-0: #050b15;
  --bg-1: #0f1f38;
  --bg-2: #142b4d;
  --bg-3: #1a355c;
  --bg-4: #203f6e;
  --text-light: #e0f7ff;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #0b1626, #051122);
  color: var(--text-light);
  line-height: 1.6;
  min-height: 100vh;
}

.container { max-width: 800px; margin: 0 auto; padding: 20px; }

/* Header */
.header {
  text-align: center;
  padding: 30px 0;
  background: linear-gradient(90deg, var(--bg-0), var(--bg-1));
  border-radius: 20px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--warning));
}

.header h1 { font-size: 2.5rem; color: var(--primary); margin-bottom: 10px; text-shadow: 0 0 20px rgba(0, 255, 153, 0.3); }
.subtitle { color: #8da1b9; font-size: 1.1rem; }

/* Panels */
.panel {
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  border: 1px solid rgba(255, 255, 255, 0.05);
  transition: transform 0.3s ease;
  position: relative;
}

.panel-0 { background: var(--bg-0); }
.panel-1 { background: var(--bg-1); }
.panel-2 { background: var(--bg-2); }
.panel-3 { background: var(--bg-3); }
.panel-4 { background: var(--bg-4); }

.panel h2 {
  font-size: 1.4rem; color: var(--primary);
  margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
}

.panel h2::before { content: ''; width: 6px; height: 24px; background: var(--primary); border-radius: 3px; }

/* Form Elements */
.file-input {
  width: 100%; padding: 16px; border: 2px dashed rgba(0, 255, 153, 0.3);
  border-radius: 12px; background: rgba(0, 0, 0, 0.2); color: white; margin-bottom: 15px;
}

.text-input {
  width: 100%; padding: 16px; border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px; background: rgba(0, 0, 0, 0.2); color: white; margin-bottom: 15px;
}

.btn {
  width: 100%; padding: 16px; border: none; border-radius: 12px;
  background: linear-gradient(135deg, var(--secondary), #1a3a5f);
  color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
}

.btn-primary { background: linear-gradient(135deg, var(--primary), #00cc7a); color: #050b15; }
.btn:hover { transform: translateY(-2px); opacity: 0.9; }

/* Boxes */
.box { background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 20px; margin-top: 20px; }
.box-title { color: var(--primary); font-size: 1.1rem; margin-bottom: 12px; }

/* Numbers */
.numbers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
.number-ball {
  width: 55px; height: 55px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem; font-weight: bold; background: var(--bg-3); color: white;
}
.number-ball.hot { background: linear-gradient(135deg, #ff6666, #cc0000); }
.number-ball.cold { background: linear-gradient(135deg, #4fc3f7, #0288d1); }
.number-ball.predict { background: linear-gradient(135deg, var(--primary), #00cc7a); color: #050b15; }

.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 15px; }
.stat-item { background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px; text-align: center; }
.stat-label { color: #8da1b9; font-size: 0.85rem; }
.stat-value { color: var(--primary); font-size: 1.2rem; font-weight: bold; }

.status { padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 0.9rem; }
.status.success { background: rgba(0, 255, 153, 0.1); border: 1px solid var(--primary); color: var(--primary); }

.loading { display: none; text-align: center; padding: 20px; }
.spinner {
  width: 30px; height: 30px; border: 3px solid rgba(0, 255, 153, 0.2);
  border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto;
}
@keyframes spin { to { transform: rotate(360deg); } }

.footer { text-align: center; padding: 30px; color: #8da1b9; font-size: 0.85rem; border-top: 1px solid rgba(255,255,255,0.05); }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ä¸‰æ˜Ÿ-é æ¸¬ç³»çµ± v2.1</h1>
    <div class="subtitle">å‹•æ…‹æ¬Šé‡æ¨¡æ“¬ | åŠ æ¬Šéš¨æ©ŸæŠ½æ¨£é‚è¼¯</div>
  </div>

  <div class="panel panel-1">
    <h2>ğŸ“Š æ•¸æ“šå°å…¥</h2>
    <input type="file" id="csvInput" class="file-input" accept=".csv">
    <div id="csvInfo"></div>
    <div class="stats-row" id="basicStats" style="display: none;"></div>
  </div>

  <div class="panel panel-2">
    <h2>ğŸ” æ™ºèƒ½åˆ†æ</h2>
    <button class="btn btn-primary" onclick="runAnalysis()">åŸ·è¡Œæ·±åº¦åˆ†æ</button>
    <div class="loading" id="loadingA"><div class="spinner"></div></div>
    <div id="panelA" style="display: none;"></div>
  </div>

  <div class="panel panel-4">
    <h2>ğŸ¯ é æ¸¬ç”Ÿæˆ</h2>
    <button class="btn btn-primary" onclick="generatePrediction()">ç”Ÿæˆæ¨¡æ“¬é æ¸¬</button>
    <div class="loading" id="loadingC"><div class="spinner"></div></div>
    <div id="panelC" style="display: none;"></div>
  </div>

  <div class="panel panel-0">
    <h2 id="toggleLogic" style="cursor: pointer;">ğŸ§  å„ªåŒ–é‚è¼¯èªªæ˜ (é»æ“Š)</h2>
    <div id="logicContent" style="display: none; padding-top: 10px;">
      <p>æœ¬ç‰ˆæœ¬æ¡ç”¨ã€Œ<b>éæ±ºå®šæ€§åŠ æ¬Šæ¨¡æ“¬</b>ã€ï¼š</p>
      <ul style="padding-left: 20px; margin-top: 10px;">
        <li><b>æ¬Šé‡è¨ˆç®—</b>ï¼š$Score = (Freq \times 500) + \min(Missing \times 1.5, 45)$ã€‚é »ç‡æ±ºå®šåœ°åŸºï¼Œéºæ¼æœŸæ•¸å¢åŠ ä¸­çæ¬Šç›Šã€‚</li>
        <li><b>å‹•æ…‹æŠ½æ¨£</b>ï¼šä½¿ç”¨è¼ªç›¤è³­ç®—æ³•ï¼Œç¢ºä¿é«˜æ¬Šé‡è™Ÿç¢¼æ˜“é¸ä¸­ï¼Œä½†ä¿ç•™éš¨æ©Ÿæ€§ã€‚</li>
        <li><b>è¿­ä»£éæ¿¾</b>ï¼šè‡ªå‹•æ¨¡æ“¬å¤šçµ„è™Ÿç¢¼ï¼Œåƒ…è¼¸å‡ºç¬¦åˆæ­·å²ã€Œå’Œå€¼ä¸­å¿ƒã€èˆ‡ã€Œå¥‡å¶å¹³è¡¡ã€çš„çµ„åˆã€‚</li>
      </ul>
    </div>
  </div>

  <div class="footer">
    <p>âš ï¸ åƒ…ä¾›å¨›æ¨‚åƒè€ƒã€‚å½©ç¥¨ç‚ºéš¨æ©Ÿäº‹ä»¶ï¼Œè«‹ç†æ€§åƒèˆ‡ã€‚</p>
  </div>
</div>

<script>
let data = [];
let analysisCache = null;

// æ–‡ä»¶åŠ è¼‰èˆ‡è§£æ
document.getElementById("csvInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    const lines = event.target.result.trim().split(/\r?\n/);
    data = [];
    lines.forEach((line, idx) => {
      if (idx === 0) return;
      const parts = line.split(",");
      if (parts.length >= 6) {
        const nums = parts.slice(1, 6).map(n => parseInt(n.trim()));
        if (nums.every(n => !isNaN(n) && n >= 1 && n <= 39)) {
          data.push({ date: parts[0], numbers: nums });
        }
      }
    });
    if (data.length > 0) {
      document.getElementById("csvInfo").innerHTML = `<div class="status success">å·²è¼‰å…¥ ${data.length} æœŸæ•¸æ“š</div>`;
      showBasicStats();
    }
  };
  reader.readAsText(file);
});

function showBasicStats() {
  const stats = calculateAdvancedStats();
  const container = document.getElementById("basicStats");
  container.style.display = "grid";
  container.innerHTML = `
    <div class="stat-item"><div class="stat-label">å¹³å‡å’Œå€¼</div><div class="stat-value">${stats.sumStats.avg}</div></div>
    <div class="stat-item"><div class="stat-label">æ¨™æº–å·®</div><div class="stat-value">${stats.sumStats.stdDev}</div></div>
    <div class="stat-item"><div class="stat-label">å¹³å‡å¥‡æ•¸</div><div class="stat-value">${stats.avgOdd}</div></div>
  `;
}

function calculateAdvancedStats() {
  const freq = {};
  const lastSeen = {};
  const sums = [];
  data.forEach((draw, idx) => {
    draw.numbers.forEach(n => {
      freq[n] = (freq[n] || 0) + 1;
      lastSeen[n] = idx;
    });
    sums.push(draw.numbers.reduce((a, b) => a + b, 0));
  });

  const avg = Math.round(sums.reduce((a, b) => a + b, 0) / sums.length);
  const variance = sums.reduce((acc, s) => acc + Math.pow(s - avg, 2), 0) / sums.length;
  const oddAvg = data.reduce((acc, d) => acc + d.numbers.filter(n => n % 2 === 1).length, 0) / data.length;

  return {
    frequency: freq,
    lastSeen: lastSeen,
    totalDraws: data.length,
    sumStats: { avg, stdDev: Math.round(Math.sqrt(variance)) },
    avgOdd: oddAvg.toFixed(1)
  };
}

function runAnalysis() {
  if (data.length === 0) return alert("è«‹å…ˆä¸Šå‚³ CSV");
  document.getElementById("loadingA").style.display = "block";
  setTimeout(() => {
    analysisCache = calculateAdvancedStats();
    displayResults(analysisCache);
    document.getElementById("loadingA").style.display = "none";
  }, 600);
}

function displayResults(stats) {
  const container = document.getElementById("panelA");
  container.style.display = "block";
  const hot = Object.entries(stats.frequency).sort((a,b)=>b[1]-a[1]).slice(0, 8);
  
  container.innerHTML = `
    <div class="box">
      <div class="box-title">ğŸ”¥ æ ¸å¿ƒç†±é–€æ± </div>
      <div class="numbers-grid">${hot.map(n => `<div class="number-ball hot">${n[0]}</div>`).join('')}</div>
    </div>
  `;
}

// --- æ ¸å¿ƒå„ªåŒ–ï¼šéš¨æ©ŸåŠ æ¬Šé æ¸¬ç®—æ³• ---
function generatePrediction() {
  if (!data.length) return alert("è«‹å°å…¥æ•¸æ“š");
  document.getElementById("loadingC").style.display = "block";
  
  setTimeout(() => {
    if (!analysisCache) analysisCache = calculateAdvancedStats();
    const stats = analysisCache;
    
    // 1. å»ºç«‹åŠ æ¬Šæ± 
    let pool = [];
    for (let i = 1; i <= 39; i++) {
      const f = stats.frequency[i] || 0;
      const daysSince = stats.totalDraws - (stats.lastSeen[i] || 0);
      // æ¬Šé‡å…¬å¼ï¼šé »ç‡åŸºç¤ + éºæ¼å¢è£œ
      const score = (f / stats.totalDraws) * 500 + Math.min(daysSince * 1.5, 45);
      pool.push({ num: i, score: score });
    }

    // 2. è¿­ä»£æŠ½æ¨£ç›´åˆ°æ»¿è¶³æ¢ä»¶
    let result = [];
    let attempts = 0;
    while (attempts < 100) {
      let tempSelection = [];
      let tempPool = [...pool];
      
      for (let i = 0; i < 5; i++) {
        let totalWeight = tempPool.reduce((s, c) => s + c.score, 0);
        let threshold = Math.random() * totalWeight;
        let acc = 0;
        for (let j = 0; j < tempPool.length; j++) {
          acc += tempPool[j].score;
          if (threshold <= acc) {
            tempSelection.push(tempPool[j].num);
            tempPool.splice(j, 1);
            break;
          }
        }
      }

      const sum = tempSelection.reduce((a, b) => a + b, 0);
      const odd = tempSelection.filter(n => n % 2 === 1).length;
      
      // ç´„æŸï¼šå’Œå€¼åœ¨å¹³å‡å€¼ä¸Šä¸‹ 20 ä»¥å…§ï¼Œä¸”å¥‡æ•¸ç‚º 2 æˆ– 3
      if (Math.abs(sum - stats.sumStats.avg) <= 20 && (odd === 2 || odd === 3)) {
        result = tempSelection.sort((a, b) => a - b);
        break;
      }
      attempts++;
    }

    if (!result.length) result = pool.sort((a,b)=>b.score - a.score).slice(0, 5).map(x=>x.num);
    
    displayPrediction(result, stats);
    document.getElementById("loadingC").style.display = "none";
  }, 800);
}

function displayPrediction(nums, stats) {
  const container = document.getElementById("panelC");
  container.style.display = "block";
  const sum = nums.reduce((a,b)=>a+b, 0);
  const odd = nums.filter(n=>n%2===1).length;

  container.innerHTML = `
    <div class="box">
      <div class="box-title">ğŸ¯ æ¨¡æ“¬é æ¸¬çµ„åˆ (éš¨æ©ŸåŠ æ¬Š)</div>
      <div class="numbers-grid">${nums.map(n => `<div class="number-ball predict">${n}</div>`).join('')}</div>
      <div class="stats-row">
        <div class="stat-item"><div class="stat-label">çµ„åˆå’Œå€¼</div><div class="stat-value">${sum}</div></div>
        <div class="stat-item"><div class="stat-label">å¥‡å¶æ¯”</div><div class="stat-value">${odd}å¥‡${5-odd}å¶</div></div>
      </div>
      <div class="status success" style="margin-top:15px">æ­¤çµ„åˆå·²é€šéæ­·å²å¸¸æ…‹åˆ†ä½ˆéæ¿¾</div>
    </div>
  `;
}

document.getElementById('toggleLogic').onclick = () => {
  const c = document.getElementById('logicContent');
  c.style.display = c.style.display === 'none' ? 'block' : 'none';
};
</script>
</body>
</html>
