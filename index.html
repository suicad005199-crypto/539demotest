<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>539 回測系統｜≥4 共振期專用</title>
<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #999; padding: 4px 6px; text-align: center; }
th { background: #eee; }
.hit { color: red; font-weight: bold; }
.period { margin-top: 25px; border-top: 2px solid #444; padding-top: 10px; }
</style>
</head>
<body>

<h2>539 回測系統（≥4 結構共振期）</h2>
<input type="file" id="csvFile" accept=".csv">
<br><button onclick="run()">執行回測</button>

<div id="summary"></div>
<div id="detail"></div>

<script>
function parseCSV(t){
  return t.trim().split("\n").slice(1).map(r=>{
    const p=r.split(",");
    return {date:p[0], nums:p.slice(1).map(Number)};
  });
}

function run(){
  const f=document.getElementById("csvFile").files[0];
  if(!f) return alert("請上傳 CSV");
  const r=new FileReader();
  r.onload=()=>{
    const d=parseCSV(r.result);

    let total=0, played=0, hit4=0;
    let detail="";

    for(let i=30;i<d.length;i++){
      total++;
      const hist=d.slice(0,i);
      const act=d[i];

      // === Gap / 熱度 ===
      const gap={}, freq={};
      for(let n=1;n<=39;n++){ gap[n]=0; freq[n]=0; }

      hist.forEach(dr=>{
        for(let n=1;n<=39;n++) gap[n]++;
        dr.nums.forEach(n=>{ gap[n]=0; freq[n]++; });
      });

      // === 評分 ===
      const score={};
      for(let n=1;n<=39;n++){
        let s=0;
        if(gap[n]>=18) s+=5;
        else if(gap[n]>=12) s+=3;

        if(freq[n]>=4) s+=4;
        else if(freq[n]>=3) s+=3;

        score[n]=s;
      }

      // ⭐ Top 8
      const pool=Object.keys(score)
        .sort((a,b)=>score[b]-score[a])
        .slice(0,8).map(Number);

      // 組合（C(8,5)=56）
      let best=null, maxScore=0;

      for(let a=0;a<pool.length;a++)
      for(let b=a+1;b<pool.length;b++)
      for(let c=b+1;c<pool.length;c++)
      for(let e=c+1;e<pool.length;e++)
      for(let f=e+1;f<pool.length;f++){
        const p=[pool[a],pool[b],pool[c],pool[e],pool[f]];

        // 條件 ② 尾數
        const tails={}, hotTails=[];
        p.forEach(n=>tails[n%10]=(tails[n%10]||0)+1);
        for(const t in tails){
          if(tails[t]>=2){
            const count = hist.slice(-10).flatMap(x=>x.nums)
              .filter(n=>n%10==t).length;
            if(count>=3) hotTails.push(t);
          }
        }
        if(hotTails.length===0) continue;

        // 條件 ③ Gap ≥18 至少 2 顆
        if(p.filter(n=>gap[n]>=18).length<2) continue;

        // 條件 ④ 熱度同步
        if(p.filter(n=>freq[n]>=3).length<3) continue;

        // 評分
        const ps=p.reduce((x,n)=>x+score[n],0);
        if(ps>maxScore){
          maxScore=ps;
          best=p;
        }
      }

      if(!best) continue; // ❌ 不出手

      played++;

      let hit=0;
      const cells=best.map(n=>{
        if(act.nums.includes(n)){ hit++; return `<span class="hit">${n}</span>`;}
        return n;
      });

      if(hit>=4) hit4++;

      detail+=`
        <div class="period">
          <b>${act.date}</b>｜開獎：${act.nums.join(", ")}<br>
          出手牌：${cells.join(" , ")}<br>
          命中：${hit}
        </div>
      `;
    }

    document.getElementById("summary").innerHTML=`
      可回測期數：${total}<br>
      出手期數：${played}<br>
      出手期 ≥4：${played? (hit4/played*100).toFixed(1):0}%
    `;
    document.getElementById("detail").innerHTML=detail;
  };
  r.readAsText(f);
}
</script>
</body>
</html>
